Upgrading RHOS 3.0 to RHOS 4.0
==============================

Prerequisites
=============

Upgrade RHEL 6.4 to RHEL 6.5
----------------------------

RHOS 4.0 will not run on RHEL 6.4.  Before beginning the RHOS upgrade
process you must upgrade to RHEL 6.5.

Upgrade MySQL 5.1 to MariaDB
----------------------------

Before upgrading to RHOS 4.0 you will need to upgrade your database
software from MySQL 5.1 to MariaDB 5.5.  As of this writing, MariaDB
in RHEL is available as part of a [software collection][scl].

1. Shut down your OpenStack services.

1. [Configure your system to access Red hat Software Collections][scl-using]

1. Shut down and disable mysql:

        # service mysqld stop
        # chkconfig mysqld off

1. Install the `mariadb55` software collection:

        # yum install mariadb55

1. Relocate the MySQL data files to the location used by the MariaDB
package:

        # rm -rf /opt/rh/mariadb55/root/var/lib/mysql/
        # cp -r /var/lib/mysql/ /opt/rh/mariadb55/root/var/lib/mysql/
        # chown -R mysql:mysql /opt/rh/mariadb55/root/var/lib/mysql/
        # restorecon -R /opt/rh/mariadb55/root/var/lib/mysql/

1. Start the MariaDB server (and configure it to start a boot):

        # service mariadb55-mysqld start
        # chkconfig mariadb55-mysqld on

1. Upgrade the databases:

        # scl enable mariadb55 mysql_upgrade

1. Restart your OpenStack services.

[scl]: https://access.redhat.com/site/documentation/en-US/Red_Hat_Software_Collections/1/html/1.0_Release_Notes/index.html
[scl-using]: https://access.redhat.com/site/documentation/en-US/Red_Hat_Software_Collections/1/html/1.0_Release_Notes/chap-Installation_and_Usage.html#sect-Installation_and_Usage-Subscribe

Upgrading from RHOS 3.0 to RHOS 4.0
===================================

Assumptions
-----------

This document assumes that your RHOS 3.0 environment was deployed
using the `packstack` deployment tool and that you have access to
the answers file (`packstack-answers-....txt`) generated by
`packstack`.

Option 1: In place upgrade with service downtime
------------------------------------------------

**Summary**: In this option, you will shut down all of your OpenStack
services, upgrade all of the components, and then bring up the updated
environment in one piece.

**Pros**: This is the simplest upgrade mechanism to implement.

**Cons**: Your OpenStack services will be unavailable for the duration of
the upgrade process.

1. Shut down your OpenStack services.

On all of the nodes in your OpenStack deployment:

1. Enable the RHOS 4.0 software repository.

<!-- BUG: There may be an issue upgrading python-urllib3. -->

1. Perform a complete upgrade:

        # yum update

On your "controller" node (the one from which you originally deployed
RHOS 3.0 using `packstack`):

1. Upgrade your OpenStack databases to the new schemas:

        # nova-manage db sync
        # glance-manage db_sync
        # cinder-manage db sync
        # keystone-manage db_sync

1. Upgrade your `packstack` answers file.

  - Replace all references to `QUANTUM` with `NEUTRON`:

            # sed -i 's/CONFIG_QUANTUM/CONFIG_NEUTRON/' $ANSWERFILE

  - Add the following lines to `$ANSWERFILE`:

            CONFIG_MYSQL_INSTALL=y
            CONFIG_CEILOMETER_INSTALL=n
            CONFIG_HEAT_INSTALL=n
            CONFIG_CINDER_BACKEND=lvm
            CONFIG_HEAT_CLOUDWATCH_INSTALL=n
            CONFIG_HEAT_CFN_INSTALL=n
            CONFIG_NOVA_NETWORK_HOSTS=...
            CONFIG_NOVA_NETWORK_MANAGER=nova.network.manager.FlatDHCPManager

<!-- BUG: This will break because of the MariaDB upgrade.  Packstack
will try (and fail) to start mysql-server rather than
mariadb55-mysql-server. -->

<!-- BUG: This requires at least openstack-nova-*-2013.2-3 due to a
variety of dependency problems in prior releases. -->

<!-- BUG: This may also fail due to parsing bugs in the Keystone
puppet provider provided by the openstack-puppet modules. -->

1. Run `packstack` to upgrade your configuration:

        # packstack --answer-file $ANSWERFILE

1. Restart your OpenStack services. 

If running `yum update` installed a new kernel package, you will need
to reboot your servers in order to activate the new kernel.  Rebooting
your compute nodes will interrupt any instances currently running on
those nodes.

Option 2:  Rolling (component-by-component) upgrades
----------------------------------------------------

**Summary**: In this option, you will upgrade components of your OpenStack
environment one at a time.

**Pros**: This will in theory allow you to continue to provide access to
your OpenStack environment throughout much of the upgrade process. For
example, while you are upgrading the Cinder component volume
operations will be unavailable, but the nova api, horizon, keystone,
and other services would still be up.

**Cons**: Some services have more impact than others. Clients will not be
able to authenticate against any of the APIs while your are upgrading
keystone, and clients will not be able to create, destroy, or
otherwise manage instances while you are upgrading nova.

Option 3: Rolling upgrades with a parallel compute region
---------------------------------------------------------

**Summary**: In this option, you will build up a separate pool of compute
nodes, allowing you to minimize downtime to the compute service.

**Pros**:

**Cons**:

